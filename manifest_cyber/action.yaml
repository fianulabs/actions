# Copyright 2023 Fianu Labs, Inc.
# SPDX-License-Identifier: Apache-2.0
name: 'Capture Manifest Cyber Evidence Using the Fianu CLI'
description: |
  This action captures evidence generated by the manifest cyber github action.
inputs:
  fianu-host:
    description: |
      Fianu host.
    required: true
  fianu-client-id:
    description: |
      Fianu client ID.
    required: true
  fianu-client-secret:
    description: |
      Fianu client secret.
    required: true
  manifest-cyber-sbom-output:
    description: |
      The path to the sbom outputted by the manifest cyber action.
    required: true
  bom-ref-path:
    description: |
      Reference to the bom ref in the JSON output. This defaults to the path for CycloneDX. For SPDX
      the path is `.name`.
    required: false
    default: '.metadata.component[\"bom-ref\"]'
  manifest-cyber-host:
    description: |
      Manifest Cyber host.
    required: false
    default: https://api.manifestcyber.com
  fianu-app-code:
    description: "Fianu App Code"
    required: true
  fianu-username:
    description: "Fianu Username (optional)"
    required: false
  fianu-asset-token:
    description: 'Fianu Asset Token associated with the Fianu Asset to which evidence should be associated.'
    required: false
    default: ''
  fianu-service-account:
    description: 'Service account identifier for generating credentials and performing keyless signing. Mutually exclusive with "identity-token".'
    required: false
    default: ''
  fianu-debug:
    description: 'Enable verbose Fianu CLI output.'
    required: false
    default: 'false'
  identity-token:
    description: 'Identity token for keyless signing. Required if "fianu-service-account" is not specified.'
    required: false
    default: ''
  audience:
    description: 'Identity token audience for generating an identity token to authenticate with Fianu.'
    required: false
    default: sigstore

runs:
  using: "composite"
  steps:
    # Extract SBOM Reference from the Manifest Cyber SBOM Output
    - name: Extract SBOM Reference
      id: sbom
      uses: sergeysova/jq-action@v2
      with:
        cmd: jq ${{ inputs.bom-ref-path }} ${{ inputs.manifest-cyber-sbom-output }} -r

    - name: Prepare Fianu Options
      id: prepare
      shell: bash
      run: |
        fianu declare --path 'manifest_cyber.sbom' --param 'bom-ref' --set ${{ steps.sbom.outputs.value }}
        fianu config declarations
        
        if [ "${{ inputs.bom-ref-path }}" = ".name" ]; then
          echo "SBOM_FORMAT=spdx-json" >> $GITHUB_ENV
        else
          echo "SBOM_FORMAT=cyclonedx-json" >> $GITHUB_ENV
        fi

    - name: Capture Blob Evidence
      uses: fianulabs/actions/capture-blob@feature/manifest-cyber-updates
      with:
        fianu-host: ${{ inputs.fianu-host }}
        fianu-app-code: ${{ inputs.fianu-app-code }}
        fianu-client-id: ${{ inputs.fianu-client-id }}
        fianu-client-secret: ${{ inputs.fianu-client-secret }}
        fianu-service-account: ${{ inputs.fianu-service-account }}
        fianu-asset-token: ${{ inputs.fianu-asset-token }}
        fianu-debug: ${{ inputs.fianu-debug }}
        audience: ${{ inputs.audience }}
        identity-token: ${{ inputs.identity-token }}
        evidence: ${{ inputs.manifest-cyber-sbom-output }}
        evidence-source: sbom.manifest_cyber
        evidence-format: ${{ env.SBOM_FORMAT }}
